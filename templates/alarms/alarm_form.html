{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm" style="max-width:860px;margin:0 auto;">
  <div class="card-header bg-white">
    <h4 class="m-0">{% if object %}编辑报警{% else %}新增报警{% endif %}</h4>
  </div>
  <div class="card-body">
    {% if form.errors %}
      <div class="alert alert-danger">请检查表单中的错误。</div>
    {% endif %}
    <form method="post" novalidate>
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">设备<span class="text-danger">*</span></label>
          {% firstof form.device form.device_id as _dev %}
          {{ _dev }}
        </div>
        <div class="col-md-6">
          <label class="form-label">类型</label>
          {% firstof form.alarm_type form.type form.category as _atype %}
          {{ _atype }}
        </div>
        <div class="col-md-6">
          <label class="form-label">状态</label>
          {% firstof form.status form.state as _st %}
          {{ _st }}
        </div>
        <div class="col-md-6">
          <label class="form-label">时间</label>
          {% firstof form.timestamp form.created_at form.time as _ts %}
          {{ _ts }}
        </div>
        <div class="col-12">
          <label class="form-label">描述</label>
          {% firstof form.description form.message form.details form.content form.note as _desc %}
          {{ _desc }}
        </div>
      </div>

      {% comment %} 渲染其它未列出的字段 {% endcomment %}
      {% for f in form.hidden_fields %}{{ f }}{% endfor %}
      <div class="mt-3">
        {% for f in form.visible_fields %}
          {% if f.name not in ('device','device_id','alarm_type','type','category','status','state','timestamp','created_at','time','description','message','details','content','note') %}
            <div class="mb-2">
              <label class="form-label">{{ f.label }}</label>
              {{ f }}
              {% if f.help_text %}<div class="form-text text-muted">{{ f.help_text }}</div>{% endif %}
              {% if f.errors %}<div class="text-danger small">{{ f.errors }}</div>{% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <div class="d-flex justify-content-end mt-4">
        <a href="{% url 'alarms:list' %}" class="btn btn-outline-secondary me-2">返回</a>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</div>

<script>
  // 自动补齐表单控件样式
  (function(){
    document.querySelectorAll('input[type=text],input[type=number],input[type=datetime-local],textarea,select').forEach(function(el){
      if(!el.className || !/form-(control|select)/.test(el.className)){
        if(el.tagName === 'SELECT'){ el.classList.add('form-select'); }
        else { el.classList.add('form-control'); }
      }
    });
  })();
</script>
{% endblock %}
